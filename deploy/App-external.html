<!DOCTYPE html>
<html>
<head>
    <title>S448071-MilestonePercentComplete</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){var e=this.getContext().getProject().ObjectID;console.log("project:",e);var t=Ext.create("Ext.panel.Panel",{title:"Percent complete report",layout:{type:"vbox",align:"stretch",padding:5},padding:5,itemId:"mainPanel"});this.myMask=new Ext.LoadMask({msg:"Please wait...",target:t});var a=Ext.create("Rally.ui.combobox.MilestoneComboBox",{fieldLabel:"Choose Milestone",multiSelect:!0,width:250,itemId:"milestoneComboBox",allowClear:!0,scope:this,listeners:{ready:function(e){console.log("ready: ",e)},select:function(e,t){console.log("comobo size:",t.length);var a=Ext.create("Ext.data.JsonStore",{fields:["milestonename","percentComplete","storiesLeft","totalPlanEstimate","blocked","totalPlanBlocked","storiesCompleted","totalPlanEstimateCompleted","defectsOpen","totalPlanEstimateDefectsOpen","targetDate"]});this.myMask.show();for(var l=[],o=0;o<t.length;o++){var c=Ext.create("Deft.Deferred"),n=o,s=t[n].get("ObjectID"),i=t[n].get("Name"),r=t[n].get("TargetDate");this._createDataCall(i,s,r,c,this),l.push(c)}Deft.Promise.all(l).then({success:function(e){a.add(e),console.log("creating grid");var t=Ext.create("Ext.grid.Panel",{height:350,columns:[{text:"Milestone Name",flex:1,sortable:!0,dataIndex:"milestonename"},{text:"Percent Complete",width:120,sortable:!0,dataIndex:"percentComplete"},{text:"# Stories Left",width:100,sortable:!0,dataIndex:"storiesLeft"},{text:"Total Plan Estimate",width:120,sortable:!0,dataIndex:"totalPlanEstimate"},{text:"# Blocked",width:75,sortable:!0,dataIndex:"blocked"},{text:"Total Plan Blocked",width:120,sortable:!0,dataIndex:"totalPlanBlocked"},{text:"# Stories ready to accept",width:150,sortable:!0,dataIndex:"storiesCompleted"},{text:"Total plan estimate to accept",width:150,sortable:!0,dataIndex:"totalPlanEstimateCompleted"},{text:"# Open Defects",width:110,sortable:!0,dataIndex:"defectsOpen"},{text:"Total plan estimate of Open Defects",width:190,sortable:!0,dataIndex:"totalPlanEstimateDefectsOpen"},{text:"Target date",xtype:"datecolumn",width:75,sortable:!0,format:"m/d/Y",dataIndex:"targetDate"}],flex:1,store:a});this.down("#mainPanel").removeAll(!0),this.down("#mainPanel").add(t),this.myMask.hide()},scope:this})},scope:this}}),l=Ext.create("Ext.panel.Panel",{layout:"hbox",align:"stretch",padding:5,itemId:"filterPanel"});l.add(a),this.add(l),this.add(t)},_createDataCall:function(e,t,a,l,o){new function(){this.milestoneName=e,this.milestoneId=t,this.deferred=l,this.that=o,this.execute=function(){console.log("executing call:",e,e,a),this._loadStories(t).then({success:function(){return this._loadDefects(t)},scope:this}).then({success:function(){return this._loadTestSets(t)},scope:this}).then({success:function(){return l.resolve(o._getStoreData(e,a,this.stories,this.defects,this.testSets))},scope:this})},this._loadStories=function(e){console.log("loading stories:",e);var t=Ext.create("Deft.Deferred");return Ext.create("Rally.data.WsapiDataStore",{model:"HierarchicalRequirement",fetch:["FormattedID","Name","ObjectID","ScheduleState","PlanEstimate","Blocked"],filters:[{property:"PortfolioItem.Milestones",operator:"contains",value:"/milestone/"+e}],limit:1/0}).load().then({success:function(e){this.stories=e,t.resolve(e)},scope:this}),t.promise},this._loadDefects=function(e){console.log("loading defects:",e);var t=Ext.create("Deft.Deferred");return Ext.create("Rally.data.WsapiDataStore",{model:"Defect",fetch:["FormattedID","Name","ObjectID","ScheduleState","PlanEstimate","Blocked"],filters:[{property:"Milestones",operator:"contains",value:"/milestone/"+e}],limit:1/0}).load().then({success:function(e){this.defects=e,t.resolve(e)},scope:this}),t.promise},this._loadTestSets=function(e){console.log("loading testSets:",e);var t=Ext.create("Deft.Deferred");return Ext.create("Rally.data.WsapiDataStore",{model:"TestSet",fetch:["FormattedID","Name","ObjectID","ScheduleState","PlanEstimate","Blocked"],filters:[{property:"Milestones",operator:"contains",value:"/milestone/"+e}],limit:1/0}).load().then({success:function(e){this.testSets=e,t.resolve(e)},scope:this}),t.promise}}(e,t,l,o).execute()},_getStoreData:function(e,t,a,l,o){var c={milestonename:e,percentComplete:this._calculatePercentComplete(a,l,o),storiesLeft:this._calculateStoriesLeft(a,l,o),totalPlanEstimate:this._calculateTotalPlanEstimate(a,l,o),blocked:this._calculateStoriesBlocked(a,l,o),totalPlanBlocked:this._calculateTotalPlanEstimateBlocked(a,l,o),storiesCompleted:this._calculateStoriesCompleted(a,l,o),totalPlanEstimateCompleted:this._calculateTotalPlanEstimateCompleted(a,l,o),defectsOpen:this._calculateDefectsOpen(l),totalPlanEstimateDefectsOpen:this._calculateTotalPlanEstimateDefectsOpen(l),targetDate:t};return console.log("milestone row:",c),c},_calculatePercentComplete:function(e,t,a){var l=0,o=0;return Ext.Array.each(e,function(e){l+=e.get("PlanEstimate"),"Ready to Ship"!=e.get("ScheduleState")&&"Accepted"!=e.get("ScheduleState")||(o+=e.get("PlanEstimate"))}),Ext.Array.each(t,function(e){l+=e.get("PlanEstimate"),"Ready to Ship"!=e.get("ScheduleState")&&"Accepted"!=e.get("ScheduleState")||(o+=e.get("PlanEstimate"))}),Ext.Array.each(a,function(e){l+=e.get("PlanEstimate"),"Ready to Ship"!=e.get("ScheduleState")&&"Accepted"!=e.get("ScheduleState")||(o+=e.get("PlanEstimate"))}),console.log("total plan estimate:",l),console.log("total artifact complete:",o),0!=l?Math.floor(o/l*100)+"%":"N/A"},_calculateStoriesLeft:function(e,t,a){var l=0;return Ext.Array.each(e,function(e){"Ready to Ship"!=e.get("ScheduleState")&&"Accepted"!=e.get("ScheduleState")&&(l+=1)}),Ext.Array.each(t,function(e){"Ready to Ship"!=e.get("ScheduleState")&&"Accepted"!=e.get("ScheduleState")&&(l+=1)}),Ext.Array.each(a,function(e){"Ready to Ship"!=e.get("ScheduleState")&&"Accepted"!=e.get("ScheduleState")&&(l+=1)}),l},_calculateTotalPlanEstimate:function(e,t,a){var l=0;return Ext.Array.each(e,function(e){"Ready to Ship"!=e.get("ScheduleState")&&"Accepted"!=e.get("ScheduleState")&&(l+=e.get("PlanEstimate"))}),Ext.Array.each(t,function(e){"Ready to Ship"!=e.get("ScheduleState")&&"Accepted"!=e.get("ScheduleState")&&(l+=e.get("PlanEstimate"))}),Ext.Array.each(a,function(e){"Ready to Ship"!=e.get("ScheduleState")&&"Accepted"!=e.get("ScheduleState")&&(l+=e.get("PlanEstimate"))}),l},_calculateStoriesBlocked:function(e,t,a){var l=0;return Ext.Array.each(e,function(e){e.get("Blocked")&&(l+=1)}),Ext.Array.each(t,function(e){e.get("Blocked")&&(l+=1)}),Ext.Array.each(a,function(e){e.get("Blocked")&&(l+=1)}),l},_calculateTotalPlanEstimateBlocked:function(e,t,a){var l=0;return Ext.Array.each(e,function(e){e.get("Blocked")&&(l+=e.get("PlanEstimate"))}),Ext.Array.each(t,function(e){e.get("Blocked")&&(l+=e.get("PlanEstimate"))}),Ext.Array.each(a,function(e){e.get("Blocked")&&(l+=e.get("PlanEstimate"))}),l},_calculateStoriesCompleted:function(e,t,a){var l=0;return Ext.Array.each(e,function(e){"Completed"==e.get("ScheduleState")&&(l+=1)}),Ext.Array.each(t,function(e){"Completed"==e.get("ScheduleState")&&(l+=1)}),Ext.Array.each(a,function(e){"Completed"==e.get("ScheduleState")&&(l+=1)}),l},_calculateTotalPlanEstimateCompleted:function(e,t,a){var l=0;return Ext.Array.each(e,function(e){"Completed"==e.get("ScheduleState")&&(l+=e.get("PlanEstimate"))}),Ext.Array.each(t,function(e){"Completed"==e.get("ScheduleState")&&(l+=e.get("PlanEstimate"))}),Ext.Array.each(a,function(e){"Completed"==e.get("ScheduleState")&&(l+=e.get("PlanEstimate"))}),l},_calculateDefectsOpen:function(e){var t=0;return Ext.Array.each(e,function(e){"Completed"!=e.get("ScheduleState")&&"Accepted"!=e.get("ScheduleState")&&"Ready to Ship"!=e.get("ScheduleState")&&(t+=1)}),t},_calculateTotalPlanEstimateDefectsOpen:function(e){var t=0;return Ext.Array.each(e,function(e){"Completed"!=e.get("ScheduleState")&&"Accepted"!=e.get("ScheduleState")&&"Ready to Ship"!=e.get("ScheduleState")&&(t+=e.get("PlanEstimate"))}),t}});

            Rally.launchApp('CustomApp', {
                name:"S448071-MilestonePercentComplete",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
