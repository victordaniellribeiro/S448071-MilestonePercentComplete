<!DOCTYPE html>
<html>
<head>
    <title>S448071-MilestonePercentComplete</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",_initDate:void 0,_endDate:void 0,_milestoneComboStore:void 0,_milestoneComboBox:void 0,items:[{xtype:"container",itemId:"header",cls:"header"},{xtype:"container",itemId:"bodyContainer",layout:{type:"hbox"},width:"100%",autoScroll:!0}],launch:function(){var e=this.getContext().getProject().ObjectID;console.log("project:",e);var t=Ext.create("Ext.panel.Panel",{title:"Percent complete report",layout:{type:"vbox",align:"stretch",padding:5},padding:5,itemId:"mainPanel"});this.myMask=new Ext.LoadMask({msg:"Please wait...",target:t}),this._milestoneComboBox=Ext.create("Rally.ui.combobox.MilestoneComboBox",{itemId:"milestoneComboBox",fieldLabel:"Choose Milestone",allowClear:!0,multiSelect:!0,width:300,scope:this,listeners:{afterrender:function(e){e.disable()},ready:function(e){console.log("ready: ",e),e.refreshStore(),e.enable()},select:function(t,a){console.log("comobo size:",a.length);var o=Ext.create("Ext.data.JsonStore",{fields:["milestonename","percentComplete","storiesLeft","totalPlanEstimate","blocked","totalPlanBlocked","storiesCompleted","totalPlanEstimateCompleted","defectsOpen","totalPlanEstimateDefectsOpen","targetDate"]});this.myMask.show();for(var l=[],i=0;i<a.length;i++){var n=Ext.create("Deft.Deferred"),s=i,c=a[s].get("ObjectID"),r=a[s].get("Name"),d=a[s].get("TargetDate"),h=a[s].get("FormattedID");console.log("Calling milestone: ",r,h),this._createDataCall(e,r,c,d,n,this),l.push(n)}Deft.Promise.all(l).then({success:function(e){console.log("before assembling grid: ",e),o.add(e),console.log("creating grid");var t=Ext.create("Ext.grid.Panel",{height:350,columns:[{text:"Milestone Name",flex:1,sortable:!0,dataIndex:"milestonename"},{text:"Percent Complete",width:120,sortable:!0,dataIndex:"percentComplete"},{text:"# Stories Left",width:100,sortable:!0,dataIndex:"storiesLeft"},{text:"Total Plan Estimate",width:120,sortable:!0,dataIndex:"totalPlanEstimate"},{text:"# Blocked",width:75,sortable:!0,dataIndex:"blocked"},{text:"Total Plan Blocked",width:120,sortable:!0,dataIndex:"totalPlanBlocked"},{text:"# Stories ready to accept",width:150,sortable:!0,dataIndex:"storiesCompleted"},{text:"Total plan estimate to accept",width:150,sortable:!0,dataIndex:"totalPlanEstimateCompleted"},{text:"# Open Defects",width:110,sortable:!0,dataIndex:"defectsOpen"},{text:"Total plan estimate of Open Defects",width:190,sortable:!0,dataIndex:"totalPlanEstimateDefectsOpen"},{text:"Target date",xtype:"datecolumn",width:75,sortable:!0,format:"m/d/Y",dataIndex:"targetDate"}],flex:1,store:o});this.down("#mainPanel").removeAll(!0),this.down("#mainPanel").add(t),this.myMask.hide()},scope:this})},scope:this}}),this._milestoneComboStore=this._milestoneComboBox.getStore(),this.down("#header").add([{xtype:"panel",autoWidth:!0,layout:"hbox",items:[{xtype:"panel",title:"Choose date range for milestone:",flex:3,align:"stretch",autoHeight:!0,bodyPadding:10,items:[{xtype:"datefield",anchor:"100%",fieldLabel:"From",scope:this,listeners:{change:function(e,t,a){this._initDate=t;this._applyMilestoneRangeFilter(this._initDate,this._endDate,this._milestoneComboStore,this)},scope:this}},{xtype:"datefield",anchor:"100%",fieldLabel:"To",scope:this,listeners:{change:function(e,t,a){this._endDate=t;this._applyMilestoneRangeFilter(this._initDate,this._endDate,this._milestoneComboStore,this)},scope:this}},{xtype:"rallyfieldvaluecombobox",fieldLabel:"Milestone Types",model:"Milestone",field:"c_Type",scope:this,listeners:{change:function(e){console.log("Milestone type: ",e.getValue()),this._milestoneType=e.getValue(),this._applyMilestoneRangeFilter(this._initDate,this._endDate,this._milestoneComboStore,this,this._milestoneType)},scope:this}},{xtype:"fieldcontainer",fieldLabel:"Milestone",pack:"end",labelAlign:"left",items:[this._milestoneComboBox]}]}]}]),this.add(t),this._milestoneComboBox.select("")},_applyMilestoneRangeFilter:function(e,t,a,o,l){!e||t||l?!t||e||l?e&&t&&!l?this._milestoneComboStore.filterBy(function(a){if(a.get("TargetDate")&&a.get("TargetDate").getTime()>e.getTime()&&a.get("TargetDate").getTime()<t.getTime())return a},o):e&&!t&&l?this._milestoneComboStore.filterBy(function(t){if(t.get("TargetDate")&&t.get("TargetDate").getTime()>e.getTime()&&t.get("c_Type")===this._milestoneType)return t},o):!e&&t&&l?this._milestoneComboStore.filterBy(function(t){if(t.get("TargetDate")&&t.get("TargetDate").getTime()<e.getTime()&&t.get("c_Type")===this._milestoneType)return t},o):e||t||!l?t&&e&&l?this._milestoneComboStore.filterBy(function(a){if(a.get("TargetDate")&&a.get("TargetDate").getTime()<t.getTime()&&a.get("TargetDate").getTime()>e.getTime()&&a.get("c_Type")===this._milestoneType)return a},o):this._milestoneComboStore.filterBy(function(e){return e}):this._milestoneComboStore.filterBy(function(e){if(e.get("c_Type")&&e.get("c_Type")===this._milestoneType)return e},o):this._milestoneComboStore.filterBy(function(e){if(e.get("TargetDate")&&e.get("TargetDate").getTime()<t.getTime())return e},o):this._milestoneComboStore.filterBy(function(t){if(t.get("TargetDate")&&t.get("TargetDate").getTime()>e.getTime())return t},o)},_createDataCall:function(e,t,a,o,l,i){new function(){this.milestoneName=t,this.milestoneId=a,this.projectId=e,this.deferred=l,this.that=i,this.execute=function(){console.log("executing call:",t,a,o),this._loadStories(e,a).then({success:function(){return this._loadDefects(a)},scope:this}).then({success:function(){return this._loadTestSets(a)},scope:this}).then({success:function(){return l.resolve(i._getStoreData(t,o,this.stories,this.defects,this.testSets))},scope:this})},this._loadStories=function(e,t){console.log("loading stories:",t);var a=Ext.create("Deft.Deferred");return Ext.create("Rally.data.WsapiDataStore",{model:"HierarchicalRequirement",context:{projectScopeUp:!1,projectScopeDown:!0,project:null},fetch:["FormattedID","Name","ObjectID","ScheduleState","PlanEstimate","Blocked"],filters:[{property:"PortfolioItem.Milestones",operator:"contains",value:"/milestone/"+t}],limit:1/0}).load().then({success:function(e){this.stories=e,a.resolve(e)},scope:this}),a.promise},this._loadDefects=function(e){console.log("loading defects:",e);var t=Ext.create("Deft.Deferred");return Ext.create("Rally.data.WsapiDataStore",{model:"Defect",context:{projectScopeUp:!1,projectScopeDown:!0,project:null},fetch:["FormattedID","Name","ObjectID","ScheduleState","PlanEstimate","Blocked"],filters:[{property:"Milestones",operator:"contains",value:"/milestone/"+e}],limit:1/0}).load().then({success:function(e){this.defects=e,t.resolve(e)},scope:this}),t.promise},this._loadTestSets=function(e){console.log("loading testSets:",e);var t=Ext.create("Deft.Deferred");return Ext.create("Rally.data.WsapiDataStore",{model:"TestSet",context:{projectScopeUp:!1,projectScopeDown:!0,project:null},fetch:["FormattedID","Name","ObjectID","ScheduleState","PlanEstimate","Blocked"],filters:[{property:"Milestones",operator:"contains",value:"/milestone/"+e}],limit:1/0}).load().then({success:function(e){this.testSets=e,t.resolve(e)},scope:this}),t.promise}}(t,a,l,i).execute()},_getStoreData:function(e,t,a,o,l){var i={milestonename:e,percentComplete:this._calculatePercentComplete(a,o,l),storiesLeft:this._calculateStoriesLeft(a,o,l),totalPlanEstimate:this._calculateTotalPlanEstimate(a,o,l),blocked:this._calculateStoriesBlocked(a,o,l),totalPlanBlocked:this._calculateTotalPlanEstimateBlocked(a,o,l),storiesCompleted:this._calculateStoriesCompleted(a,o,l),totalPlanEstimateCompleted:this._calculateTotalPlanEstimateCompleted(a,o,l),defectsOpen:this._calculateDefectsOpen(o),totalPlanEstimateDefectsOpen:this._calculateTotalPlanEstimateDefectsOpen(o),targetDate:t};return console.log("milestone row:",i),i},_calculatePercentComplete:function(e,t,a){var o=0,l=0;return Ext.Array.each(e,function(e){o+=e.get("PlanEstimate"),"Ready to Ship"!==e.get("ScheduleState")&&"Accepted"!==e.get("ScheduleState")||(l+=e.get("PlanEstimate"))}),Ext.Array.each(t,function(e){o+=e.get("PlanEstimate"),"Ready to Ship"!==e.get("ScheduleState")&&"Accepted"!==e.get("ScheduleState")||(l+=e.get("PlanEstimate"))}),Ext.Array.each(a,function(e){o+=e.get("PlanEstimate"),"Ready to Ship"!==e.get("ScheduleState")&&"Accepted"!==e.get("ScheduleState")||(l+=e.get("PlanEstimate"))}),console.log("total plan estimate:",o),console.log("total artifact complete:",l),0!=o?Math.floor(l/o*100)+"%":"N/A"},_calculateStoriesLeft:function(e,t,a){var o=0;return Ext.Array.each(e,function(e){"Ready to Ship"!==e.get("ScheduleState")&&"Accepted"!==e.get("ScheduleState")&&(o+=1)}),Ext.Array.each(t,function(e){"Ready to Ship"!==e.get("ScheduleState")&&"Accepted"!==e.get("ScheduleState")&&(o+=1)}),Ext.Array.each(a,function(e){"Ready to Ship"!==e.get("ScheduleState")&&"Accepted"!==e.get("ScheduleState")&&(o+=1)}),o},_calculateTotalPlanEstimate:function(e,t,a){var o=0;return Ext.Array.each(e,function(e){"Ready to Ship"!=e.get("ScheduleState")&&"Accepted"!=e.get("ScheduleState")&&(o+=e.get("PlanEstimate"))}),Ext.Array.each(t,function(e){"Ready to Ship"!=e.get("ScheduleState")&&"Accepted"!=e.get("ScheduleState")&&(o+=e.get("PlanEstimate"))}),Ext.Array.each(a,function(e){"Ready to Ship"!=e.get("ScheduleState")&&"Accepted"!=e.get("ScheduleState")&&(o+=e.get("PlanEstimate"))}),o},_calculateStoriesBlocked:function(e,t,a){var o=0;return Ext.Array.each(e,function(e){e.get("Blocked")&&(o+=1)}),Ext.Array.each(t,function(e){e.get("Blocked")&&(o+=1)}),Ext.Array.each(a,function(e){e.get("Blocked")&&(o+=1)}),o},_calculateTotalPlanEstimateBlocked:function(e,t,a){var o=0;return Ext.Array.each(e,function(e){e.get("Blocked")&&(o+=e.get("PlanEstimate"))}),Ext.Array.each(t,function(e){e.get("Blocked")&&(o+=e.get("PlanEstimate"))}),Ext.Array.each(a,function(e){e.get("Blocked")&&(o+=e.get("PlanEstimate"))}),o},_calculateStoriesCompleted:function(e,t,a){var o=0;return Ext.Array.each(e,function(e){"Completed"==e.get("ScheduleState")&&(o+=1)}),Ext.Array.each(t,function(e){"Completed"==e.get("ScheduleState")&&(o+=1)}),Ext.Array.each(a,function(e){"Completed"==e.get("ScheduleState")&&(o+=1)}),o},_calculateTotalPlanEstimateCompleted:function(e,t,a){var o=0;return Ext.Array.each(e,function(e){"Completed"==e.get("ScheduleState")&&(o+=e.get("PlanEstimate"))}),Ext.Array.each(t,function(e){"Completed"==e.get("ScheduleState")&&(o+=e.get("PlanEstimate"))}),Ext.Array.each(a,function(e){"Completed"==e.get("ScheduleState")&&(o+=e.get("PlanEstimate"))}),o},_calculateDefectsOpen:function(e){var t=0;return Ext.Array.each(e,function(e){"Completed"!=e.get("ScheduleState")&&"Accepted"!=e.get("ScheduleState")&&"Ready to Ship"!=e.get("ScheduleState")&&(t+=1)}),t},_calculateTotalPlanEstimateDefectsOpen:function(e){var t=0;return Ext.Array.each(e,function(e){"Completed"!=e.get("ScheduleState")&&"Accepted"!=e.get("ScheduleState")&&"Ready to Ship"!=e.get("ScheduleState")&&(t+=e.get("PlanEstimate"))}),t}});

            Rally.launchApp('CustomApp', {
                name:"S448071-MilestonePercentComplete",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
